!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("rxjs"),require("d3")):"function"==typeof define&&define.amd?define("ng-whiteboard",["exports","@angular/core","rxjs","d3"],e):e((t=t||self)["ng-whiteboard"]={},t.ng.core,t.rxjs,t.d3)}(this,(function(t,e,i,n){"use strict";var o=function(){function t(){this.eraseSvgMethodCallSource=new i.Subject,this.saveSvgMethodCallSource=new i.Subject,this.undoSvgMethodCallSource=new i.Subject,this.redoSvgMethodCallSource=new i.Subject,this.addImageMethodCallSource=new i.Subject,this.eraseSvgMethodCalled$=this.eraseSvgMethodCallSource.asObservable(),this.saveSvgMethodCalled$=this.saveSvgMethodCallSource.asObservable(),this.undoSvgMethodCalled$=this.undoSvgMethodCallSource.asObservable(),this.redoSvgMethodCalled$=this.redoSvgMethodCallSource.asObservable(),this.addImageMethodCalled$=this.addImageMethodCallSource.asObservable()}return t.prototype.erase=function(){this.eraseSvgMethodCallSource.next()},t.prototype.save=function(t,e){void 0===t&&(t="New image"),void 0===e&&(e="png"),this.saveSvgMethodCallSource.next({name:t,format:e})},t.prototype.undo=function(){this.undoSvgMethodCallSource.next()},t.prototype.redo=function(){this.redoSvgMethodCallSource.next()},t.prototype.addImage=function(t){this.addImageMethodCallSource.next(t)},t.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],t.ɵprov=e.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t}();var r=function(){this.color="#000000",this.backgroundColor="#ffffff",this.size="5px",this.linejoin="round",this.linecap="round"};var a={Line:0,Image:1};a[a.Line]="Line",a[a.Image]="Image";var s=function(){function t(t){this.whiteboardService=t,this.whiteboardOptions=new r,this.init=new e.EventEmitter,this.clear=new e.EventEmitter,this.undo=new e.EventEmitter,this.redo=new e.EventEmitter,this.save=new e.EventEmitter,this.imageAdded=new e.EventEmitter,this.selection=void 0,this.subscriptionList=[],this.undoStack=[],this.redoStack=[],this.b64toBlob=function(t,e){void 0===e&&(e=512);for(var i=t.split(","),n=i[0].match(/:(.*?);/)[1],o=atob(i[1]),r=[],a=0;a<o.length;a+=e){for(var s=o.slice(a,a+e),c=new Array(s.length),h=0;h<s.length;h++)c[h]=s.charCodeAt(h);var u=new Uint8Array(c);r.push(u)}return new Blob(r,{type:n})}}return t.prototype.ngAfterViewInit=function(){var t=this;this.subscriptionList.push(this.whiteboardService.eraseSvgMethodCalled$.subscribe((function(){return t.eraseSvg(t.selection)}))),this.subscriptionList.push(this.whiteboardService.saveSvgMethodCalled$.subscribe((function(e){var i=e.name,n=e.format;return t.saveSvg(i,n)}))),this.subscriptionList.push(this.whiteboardService.undoSvgMethodCalled$.subscribe((function(){return t.undoDraw()}))),this.subscriptionList.push(this.whiteboardService.redoSvgMethodCalled$.subscribe((function(){return t.redoDraw()}))),this.subscriptionList.push(this.whiteboardService.addImageMethodCalled$.subscribe((function(e){return t.addImage(e)}))),this.selection=this.initSvg(this.svgContainer.nativeElement)},t.prototype.ngOnDestroy=function(){var t=this;this.subscriptionList.forEach((function(e){return t._unsubscribe(e)}))},t.prototype.initSvg=function(t){var e=this,i=n.line().curve(n.curveBasis),o=n.select(t).call(n.drag().container(t).subject((function(){var t=[n.event.x,n.event.y];return[t,t]})).on("start",(function(){var t=n.event.subject,r=o.append("path").datum(t).attr("class","line").attr("style","\n           fill: none;\n           stroke: "+(e.color||e.whiteboardOptions.color)+";\n           stroke-width: "+(e.size||e.whiteboardOptions.size)+";\n           stroke-linejoin: "+(e.linejoin||e.whiteboardOptions.linejoin)+";\n           stroke-linecap: "+(e.linecap||e.whiteboardOptions.linecap)+";\n           ");r.attr("d",i),n.event.on("drag",(function(){r.datum().push(n.mouse(this)),r.attr("d",i)})),n.event.on("end",(function(){r.attr("d",i),e.undoStack.length<1&&(e.redoStack=[]),e.undoStack.push({type:a.Line,line:r.node()})}))})));return this.init.emit(),o},t.prototype.addImage=function(t){this.drawImage(t)},t.prototype.eraseSvg=function(t){t.selectAll("*").remove(),this.undoStack=[],this.redoStack=[],this.clear.emit()},t.prototype.saveSvg=function(t,e){var i=this,n=this.saveAsSvg(this.selection.clone(!0).node());"svg"===e?this.download("data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(n))),t):this.svgString2Image(n,Number(this.selection.style("width").replace("px","")),Number(this.selection.style("height").replace("px","")),e,(function(e){i.download(e,t)}))},t.prototype.undoDraw=function(){var t=this;this.undoStack.length&&(this.redoStack.push(this.undoStack.pop()),this.selection.selectAll(".line").remove(),this.undoStack.forEach((function(e){e.type===a.Line?t.drawLine(e.line):e.type===a.Image&&t.drawLine(e.image)})),this.undo.emit())},t.prototype.redoDraw=function(){var t=this;this.redoStack.length&&(this.undoStack.push(this.redoStack.pop()),this.selection.selectAll(".line").remove(),this.undoStack.forEach((function(e){e.type===a.Line?t.drawLine(e.line):e.type===a.Image&&t.drawLine(e.image)})),this.redo.emit())},t.prototype.drawLine=function(t){this.selection.node().appendChild(t)},t.prototype.drawImage=function(t){var e=this,i=this.selection.append("g").data([{x:20,y:20,r:1,scale:1}]).attr("x",0).attr("y",0).attr("transform","translate(0,0)"),o=new Image;o.onload=function(){o.width,o.height;var r=Number(e.selection.style("height").replace("px","")),a=Number(e.selection.style("width").replace("px",""));i.append("image").attr("x",0).attr("y",0).attr("height",r).attr("width",a).attr("preserveAspectRatio","none").attr("xlink:href",t.toString()),i.append("rect").attr("x",0).attr("y",0).attr("width",20).attr("height",20).style("opacity",0).attr("fill",(function(t){return"#cccccc"})).call(n.drag().subject((function(){var t=[n.event.x,n.event.y];return[t,t]})).on("start",(function(){n.event.on("drag",(function(t){var e=n.select(this),i=n.mouse(this);t.x+=i[0]-Number(e.attr("width"))/2,t.y+=i[1]-Number(e.attr("height"))/2,n.select(this.parentNode).attr("transform",(function(){return"translate("+[t.x,t.y]+"),rotate(0,160, 160),scale("+t.scale+","+t.scale+")"}))}))}))),i.on("mouseover",(function(){n.select(this).select("rect").style("opacity",1)})).on("mouseout",(function(){n.select(this).select("rect").style("opacity",0)}))},o.src=t.toString()},t.prototype._unsubscribe=function(t){t&&t.unsubscribe()},t.prototype.svgString2Image=function(t,e,i,n,o){n=n||"png";var r="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t))),a=document.createElement("canvas"),s=a.getContext("2d");a.width=e,a.height=i;var c=new Image;c.onload=function(){s.clearRect(0,0,e,i),s.drawImage(c,0,0,e,i);var t=a.toDataURL("image/"+n);o(t)},c.src=r},t.prototype.saveAsSvg=function(t){t.setAttribute("xlink","http://www.w3.org/1999/xlink");var e=(new XMLSerializer).serializeToString(t);return e=(e=e.replace(/(\w+)?:?xlink=/g,"xmlns:xlink=")).replace(/NS\d+:href/g,"xlink:href")},t.prototype.download=function(t,e){var i=this.b64toBlob(t);return this.save.emit(i),i},t.decorators=[{type:e.Component,args:[{selector:"ng-whiteboard-btc",template:'\n    <svg #svgContainer [style.background-color]="this.backgroundColor || this.whiteboardOptions.backgroundColor"></svg>\n  ',styles:[":host{width:inherit;height:inherit;min-width:inherit;min-height:inherit;max-width:inherit;max-height:inherit}:host svg{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:inherit;height:inherit;min-width:inherit;min-height:inherit;max-width:inherit;max-height:inherit;cursor:url(cursor.svg) 5 5,crosshair;background-size:cover;background-position:50%;background-repeat:no-repeat}:host svg .bg-image{position:relative}:host svg .bg-image .image-cursor{position:absolute;width:10px;height:10px;background-color:#080;top:0;right:0}"]}]}],t.ctorParameters=function(){return[{type:o}]},t.propDecorators={svgContainer:[{type:e.ViewChild,args:["svgContainer",{static:!1}]}],whiteboardOptions:[{type:e.Input}],color:[{type:e.Input}],backgroundColor:[{type:e.Input}],size:[{type:e.Input}],linejoin:[{type:e.Input}],linecap:[{type:e.Input}],init:[{type:e.Output}],clear:[{type:e.Output}],undo:[{type:e.Output}],redo:[{type:e.Output}],save:[{type:e.Output}],imageAdded:[{type:e.Output}]},t}();var c=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{declarations:[s],imports:[],exports:[s]}]}],t}();t.NgWhiteboardComponent=s,t.NgWhiteboardModule=c,t.NgWhiteboardService=o,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ng-whiteboard.umd.min.js.map